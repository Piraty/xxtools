#!/bin/sh
# xxbuild [flags] [pkgs..] - build packages for a pre-defined set of archs

cd "$(xdistdir)" || exit 1

: "${XBPS_HOSTDIR:="$HOME/.cache/xxbuild/hostdir"}"
: "${XBPS_MASTERDIR:="$(pwd)/masterdir.xxbuild"}"

flags=
for arg in $@; do
	case "$arg" in
		-*)
			flags="$flags $arg"
			shift
			;;
		*) break ;;
	esac
done

# if no packages are given, build changed templates commited on this branch
if [ "$#" -lt 1 ]; then
	rm -f /tmp/templates
	common/travis/changed_templates.sh &&
		set -- $(cat /tmp/templates)
fi
pkgs=$(./xbps-src sort-dependencies "$@")
[ -n "$pkgs" ] || exit 1

mkdir -p "$XBPS_HOSTDIR" "$XBPS_MASTERDIR"
export XBPS_HOSTDIR
export XBPS_MASTERDIR

./xbps-src binary-bootstrap
./xbps-src clean
./xbps-src bootstrap-update

for arch in "" "-a aarch64-musl" "-a armv7l"; do
	# mimic xbulk but check the returncode
	#xbulk $flags $(./xbps-src sort-dependencies $pkgs #NO, we can't filter retcode
	for pkg in $pkgs; do
		./xbps-src $flags $arch pkg $pkg
		ret=$?
		case "$ret" in
			0) : ;;
			2) : ;; # nocross, broken, no match in `archs=`
			*)
				printf '+++ %s\n' "pkg: $pkg" "arch: ${arch:-(native)}" >&2
				exit $ret
				;;
		esac
	done
done
